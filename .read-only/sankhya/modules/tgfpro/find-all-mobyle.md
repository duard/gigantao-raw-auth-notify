SELECT *
FROM (
    SELECT 
        ROW_NUMBER() OVER (
            ORDER BY 
                CASE
                    WHEN TGFPRO.ESTMIN IS NOT NULL AND TGFPRO.ESTMAX IS NOT NULL AND ISNULL(TGFEST.ESTOQUE,0) > TGFPRO.ESTMIN THEN 1
                    WHEN TGFPRO.ESTMIN IS NOT NULL AND ISNULL(TGFEST.ESTOQUE,0) < TGFPRO.ESTMIN THEN 0
                    WHEN TGFPRO.ESTMIN IS NOT NULL AND TGFPRO.ESTMAX IS NOT NULL AND ISNULL(TGFEST.ESTOQUE,0) BETWEEN TGFPRO.ESTMIN AND TGFPRO.ESTMAX THEN 1
                    WHEN TGFPRO.ESTMIN = 0 AND TGFPRO.ESTMAX = 0 THEN 3
                    WHEN TGFPRO.ESTMIN IS NULL OR TGFPRO.ESTMAX IS NULL THEN 4
                    ELSE 5
                END,
                (TGFPRO.ESTMIN - ISNULL(TGFEST.ESTOQUE,0))
        ) AS RN,

        -- Produto
        TGFPRO.CODPROD,
        TGFPRO.DESCRPROD,
        TGFPRO.CODGRUPOPROD,
        TGFGRU.DESCRGRUPOPROD,
        TGFPRO.LOCALIZACAO, 
        TGFPRO.ESTMIN, 
        TGFPRO.ESTMAX,

        -- Estoque por local
        TGFEST.CODEMP, 
        TGFEST.CODLOCAL,
        TGFLOC.DESCRLOCAL, 
        TGFEST.CONTROLE, 
        ISNULL(TGFEST.ESTOQUE,0) AS ESTOQUE,
        ISNULL(TGFEST.RESERVADO,0) AS RESERVADO, 
        (ISNULL(TGFEST.ESTOQUE,0) - ISNULL(TGFEST.RESERVADO,0)) AS DISPONIVEL,

        -- Necessidade de compra
        CASE
            WHEN ISNULL(TGFPRO.ESTMAX, 0) - ISNULL(TGFEST.ESTOQUE,0) < 0 THEN 0
            ELSE ISNULL(TGFPRO.ESTMAX, 0) - ISNULL(TGFEST.ESTOQUE,0)
        END AS Necessidade_de_compra,

        -- Status do estoque
        CASE
            WHEN TGFPRO.ESTMIN IS NULL OR TGFPRO.ESTMAX IS NULL THEN 'Dados faltando'
            WHEN TGFPRO.ESTMIN = 0 AND TGFPRO.ESTMAX = 0 THEN 'Sem controle'
            WHEN (ISNULL(TGFEST.ESTOQUE,0) - TGFPRO.ESTMIN) < 0 THEN 'Disponível negativo'
            WHEN ISNULL(TGFEST.ESTOQUE,0) < TGFPRO.ESTMIN THEN 'Abaixo do mínimo'
            WHEN ISNULL(TGFEST.ESTOQUE,0) BETWEEN TGFPRO.ESTMIN AND TGFPRO.ESTMAX THEN 'Dentro da faixa'
            WHEN ISNULL(TGFEST.ESTOQUE,0) > TGFPRO.ESTMAX THEN 'Acima do máximo'
            ELSE 'Outros'
        END AS STATUS_ESTOQUE,

        -- Usuário logado
        (SELECT CODUSU FROM TSIULG WHERE SPID = @@SPID) AS codusu

    FROM TGFPRO
    LEFT JOIN TGFEST ON TGFEST.CODPROD = TGFPRO.CODPROD
    LEFT JOIN TGFLOC ON TGFLOC.CODLOCAL = TGFEST.CODLOCAL
    JOIN TGFGRU ON TGFGRU.CODGRUPOPROD = TGFPRO.CODGRUPOPROD
    
    WHERE 
        1 = 1

   
         AND (:CODLOCAL IS NULL OR TGFEST.CODLOCAL = :CODLOCAL)
         AND (:CODPROD IS NULL OR TGFPRO.CODPROD = :CODPROD)
         AND (:CODGRU IS NULL OR TGFPRO.CODGRUPOPROD = :CODGRU)
         AND (TGFPRO.DESCRPROD COLLATE Latin1_General_CI_AI LIKE '%' + :BUSCA + '%' OR :BUSCA IS NULL)

) AS QRY
WHERE 1=1


