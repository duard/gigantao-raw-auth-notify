

x-common-env: &common-env
  build:
    context: .
    dockerfile: Dockerfile
    args:
      MY_UID: ${MY_UID:-1001}
      MY_GID: ${MY_GID:-1001}
  volumes:
    - .:/app
    - /app/node_modules
    - ./wait-for-it.sh:/app/wait-for-it.sh # Ensure wait-for-it.sh is in the root
  user: root
  environment:
    - FORCE_COLOR=3
    - TZ=America/Sao_Paulo
  networks:
    - default

services:
  api-auth-development:
    <<: *common-env
    container_name: api-auth-development
    profiles: ["development"]
    ports:
      - "0.0.0.0:3203:3101"
    env_file:
      - .env.dev
    environment:
      - NODE_ENV=development
      - MYSQL_HOST=mysql
    depends_on:
      - mysql
    command: dumb-init sh -c "./wait-for-it.sh mysql:3306 -- $START_CMD"

  api-auth-local:
    <<: *common-env
    container_name: api-auth-local
    profiles: ["local"]
    ports:
      - "0.0.0.0:3103:3101"
    env_file:
      - .env.local
    environment:
      - NODE_ENV=development # Assuming local is also for development
      - MYSQL_HOST=mysql
    depends_on:
      - mysql
    command: dumb-init sh -c "./wait-for-it.sh mysql:3306 -- $START_CMD"

  api-auth-homologation:
    <<: *common-env
    container_name: api-auth-homologation
    profiles: ["homologation"]
    ports:
      - "0.0.0.0:3303:3101"
    env_file:
      - .env.homolog
    environment:
      - NODE_ENV=production
    networks:
      - coolify # Connects to the external Coolify network for Redis and MySQL
      - default # Also connect to default for internal communication if needed

  api-auth-test:
    <<: *common-env
    container_name: api-auth-test
    profiles: ["test"]
    ports:
      - "0.0.0.0:3403:3101"
    env_file:
      - .env.test
    environment:
      - NODE_ENV=test
    networks:
      - coolify # Connects to the external Coolify network for Redis and MySQL
      - default # Also connect to default for internal communication if needed

  api-auth-production:
    <<: *common-env
    container_name: api-auth-production
    profiles: ["production"]
    ports:
      - "0.0.0.0:3503:3101"
    env_file:
      - .env.production
    environment:
      - NODE_ENV=production
    networks:
      - coolify # Connects to the external Coolify network for Redis and MySQL
      - default # Also connect to default for internal communication if needed
    command: dumb-init sh -c "pnpm run start"

  mysql:
    image: mysql:8
    container_name: mysql
    profiles: ["development", "local"] # MySQL service only for development and local
    environment:
      MYSQL_ROOT_PASSWORD: 12345
      MYSQL_DATABASE: gigantao_auth_notify_dev
      TZ: America/Sao_Paulo
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - default

networks:
  default:
    driver: bridge
  coolify:
    external: true

volumes:
  mysql_data: